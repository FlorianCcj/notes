[Unit]
Description=Start Gitlab-omnibus Server
After=docker.service
Requires=docker.service

[Service]
Restart=on-failure
ExecStartPre=-/usr/bin/docker kill gitlab-runner
ExecStartPre=-/usr/bin/docker rm gitlab-runner
ExecStart=/usr/bin/docker run \
    --rm \
    --name gitlab-runner \
    --hostname gitlab-runner \
    --network=host \
    -e REGISTRATION_TOKEN={{ gitlab_runner_registration_token }} \ {# runner_shared_token #}
    -e CI_SERVER_URL={{ gitlab_runner_ci_server_url }} \ {# http://localhost:4080 #}
    -e RUNNER_EXECUTOR=docker \
    -e DOCKER_IMAGE={{ gitlab_runner_docker_image }} \ {# debian:latest #}
    -e RUNNER_NAME=runner-127.0.0.1 \
    -v /var/run/docker.sock:/var/run/docker.sock
    -v /var/opt/gitlab-runner/config/runner:/etc/gitlab-runner \
    -v /usr/bin/docker:/bin/docker \
    -p 80:80 \
    -p 8080:9252 \
    gitlab-runner:v12.1.0 \
    register --docker-volumes /var/run/docker.sock:/var/run/docker.sock --docker-volumes /usr/bin/docker:/bin/docker -n
    # -e DOCKER_PRIVILEGED="true"
ExecStop=/usr/bin/docker stop gitlab-runner
ExecStopPost=-/usr/bin/docker rm gitlab-runner

[Install]
WantedBy=multi-user.target
